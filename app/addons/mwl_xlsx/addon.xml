<?xml version="1.0" encoding="UTF-8"?>
<addon scheme="3.0">
    <id>mwl_xlsx</id>
    <version>0.1.1</version>
    <priority>1100</priority>
    <position>0</position>
    <compatibility>
        <dependencies>vendor_communication</dependencies>
    </compatibility>

    <autoload>
        <psr4 prefix="Tygh\Addons\MwlXlsx\">src</psr4>
    </autoload>

    <!-- Устанавливать во всех редакциях с витриной -->
    <auto_install>MULTIVENDOR,ULTIMATE</auto_install>
    <default_language>en</default_language>

    <name>Media Lists</name>
    <description>Adds multiple media lists per user without core changes (hooks, own tables, UI on product buttons).</description>

    <install>fn_mwl_xlsx_install</install>
    <uninstall>fn_mwl_xlsx_uninstall</uninstall>

    <!-- Установочные/деинсталляционные SQL -->
    <queries>
        <!-- install -->
        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_xlsx_lists` (
        `list_id` INT AUTO_INCREMENT PRIMARY KEY,
        `user_id` INT UNSIGNED NOT NULL DEFAULT 0,
        `session_id` VARCHAR(64) NOT NULL DEFAULT '',
        `name` VARCHAR(255) NOT NULL,
        `is_private` TINYINT(1) NOT NULL DEFAULT 0,
        `created_at` DATETIME NOT NULL,
        `updated_at` DATETIME NOT NULL
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
        ]]></item>

        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_xlsx_list_products` (
        `list_id` INT NOT NULL,
        `product_id` INT NOT NULL,
        `product_options` TEXT,
        `amount` INT NOT NULL DEFAULT 1,
        `timestamp` INT NOT NULL,
        PRIMARY KEY (`list_id`, `product_id`, `timestamp`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
        ]]></item>

        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_xlsx_templates` (
        `template_id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
        `company_id` INT UNSIGNED NOT NULL DEFAULT 0,
        `name` VARCHAR(255) NOT NULL,
        `path` VARCHAR(255) NOT NULL,
        `size` INT UNSIGNED NOT NULL DEFAULT 0,
        `created_at` INT UNSIGNED NOT NULL,
        `updated_at` INT UNSIGNED NOT NULL,
        PRIMARY KEY (`template_id`),
        KEY `company_id` (`company_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8
        ]]></item>

        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_planfix_links` (
            `link_id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
            `company_id` INT UNSIGNED NOT NULL DEFAULT 0,
            `entity_type` VARCHAR(32) NOT NULL,
            `entity_id` INT UNSIGNED NOT NULL,
            `planfix_object_id` VARCHAR(64) NOT NULL,
            `planfix_object_type` VARCHAR(32) NOT NULL DEFAULT '',
            `extra` TEXT NULL,
            `created_at` INT UNSIGNED NOT NULL,
            `updated_at` INT UNSIGNED NOT NULL,
            PRIMARY KEY (`link_id`),
            UNIQUE KEY `entity_planfix` (`company_id`, `entity_type`, `entity_id`, `planfix_object_type`, `planfix_object_id`),
            KEY `planfix_object` (`planfix_object_type`, `planfix_object_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        ]]></item>

        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_settings_backup` (
          `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
          `addon` VARCHAR(64) NOT NULL,
          `settings_json` MEDIUMTEXT NOT NULL,
          `created_at` INT UNSIGNED NOT NULL,
          PRIMARY KEY (`id`),
          UNIQUE KEY `addon` (`addon`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        ]]></item>

        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_planfix_status_map` (
            `map_id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
            `company_id` INT UNSIGNED NOT NULL DEFAULT 0,
            `entity_type` VARCHAR(32) NOT NULL,
            `entity_status` VARCHAR(32) NOT NULL,
            `planfix_status_id` VARCHAR(64) NOT NULL,
            `planfix_status_name` VARCHAR(255) NOT NULL,
            `planfix_status_type` VARCHAR(32) NOT NULL,
            `is_default` TINYINT(1) NOT NULL DEFAULT 0,
            `created_at` INT UNSIGNED NOT NULL,
            `updated_at` INT UNSIGNED NOT NULL,
            PRIMARY KEY (`map_id`),
            UNIQUE KEY `entity_status` (`company_id`, `entity_type`, `entity_status`),
            KEY `planfix_status` (`planfix_status_id`, `planfix_status_type`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        ]]></item>

        <item for="install"><![CDATA[
        CREATE TABLE IF NOT EXISTS `?:mwl_planfix_events` (
            `event_id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
            `company_id` INT UNSIGNED NOT NULL DEFAULT 0,
            `link_id` INT UNSIGNED DEFAULT NULL,
            `event_type` VARCHAR(64) NOT NULL,
            `status` VARCHAR(16) NOT NULL DEFAULT 'pending',
            `payload` MEDIUMTEXT NOT NULL,
            `error` TEXT NULL,
            `attempts` INT UNSIGNED NOT NULL DEFAULT 0,
            `created_at` INT UNSIGNED NOT NULL,
            `updated_at` INT UNSIGNED NOT NULL,
            `processed_at` INT UNSIGNED DEFAULT NULL,
            PRIMARY KEY (`event_id`),
            KEY `status` (`status`),
            KEY `company_event` (`company_id`, `event_type`),
            KEY `link_id` (`link_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        ]]></item>

        <!-- uninstall -->
        <!-- <item for="uninstall"><![CDATA[
        DROP TABLE IF EXISTS `?:mwl_planfix_events`;
        ]]></item>

        <item for="uninstall"><![CDATA[
        DROP TABLE IF EXISTS `?:mwl_planfix_status_map`;
        ]]></item>

        <item for="uninstall"><![CDATA[
        DROP TABLE IF EXISTS `?:mwl_planfix_links`;
        ]]></item>

        <item for="uninstall"><![CDATA[
        DROP TABLE IF EXISTS `?:mwl_xlsx_templates`;
        ]]></item>

        <item for="uninstall"><![CDATA[
        DROP TABLE IF EXISTS `?:mwl_xlsx_list_products`;
        ]]></item>

        <item for="uninstall"><![CDATA[
        DROP TABLE IF EXISTS `?:mwl_xlsx_lists`;
        ]]></item> -->
    </queries>


    <!-- Языковые переменные -->
    <languages>
        <item>
            <name>en</name>
            <values>
                <value id="mwl_xlsx.add_all_to_wishlist">Add all to media list</value>
                <value id="mwl_xlsx.add_to_wishlist">Add to media list</value>
                <value id="mwl_xlsx.added_plain">Added to media list</value>
                <value id="mwl_xlsx.added"><![CDATA[Added to <a href="[list_url]">[list_name]</a>]]></value>
                <value id="mwl_xlsx.allowed_usergroups">User groups allowed for media lists</value>
                <value id="mwl_xlsx.authorized_usergroups">Authorized user groups</value>
                <value id="mwl_xlsx.confirm_remove">Remove this list?</value>
                <value id="mwl_xlsx.description">Create and manage multiple media lists.</value>
                <value id="mwl_xlsx.enter_list_name">Enter list name</value>
                <value id="mwl_xlsx.export_google">Export Google Sheets</value>
                <value id="mwl_xlsx.google_credentials">Google credentials (JSON)</value>
                <value id="mwl_xlsx.google_drive_folder_id">Google Drive folder ID (optional, Shared Drive supported)</value>
                <value id="mwl_xlsx.hide_price_for_guests">Hide price for unauthorized</value>
                <value id="mwl_xlsx.list_limit_reached">You cannot add more than [limit] items to a media list</value>
                <value id="mwl_xlsx.login_to_view_price">Log in to view price</value>
                <value id="mwl_xlsx.max_list_items">Maximum items per list</value>
                <value id="mwl_xlsx.setting.compact_price_slider_labels">Compact price slider labels</value>
                <value id="mwl_xlsx.setting.compact_price_slider_labels.desc">Show min/max slider labels in a compact format without affecting filter values.</value>
                <value id="mwl_xlsx.shortnum_thousand"> K</value>
                <value id="mwl_xlsx.shortnum_million"> M</value>
                <value id="mwl_xlsx.shortnum_billion"> B</value>
                <value id="mwl_xlsx.shortnum_trillion"> T</value>
                <value id="mwl_xlsx.my_lists">My media lists</value>
                <value id="mwl_xlsx.name">Media Lists</value>
                <value id="mwl_xlsx.new_list">New list…</value>
                <value id="mwl_xlsx.remove_from_list">Remove from list</value>
                <value id="mwl_xlsx.remove">Remove</value>
                <value id="mwl_xlsx.removed">Removed</value>
                <value id="mwl_xlsx.rename">Rename</value>
                <value id="mwl_xlsx.show_extra_button">Show extra button in list</value>
                <value id="mwl_xlsx.select_list">Select media list</value>
                <value id="mwl_xlsx.wishlists">Media lists</value>
                <value id="mwl_xlsx.planfix_task">Planfix task</value>
                <value id="mwl_xlsx.planfix_origin">Planfix origin</value>
                <value id="mwl_xlsx.planfix_origin.desc">Base Planfix URL (example: https://example.planfix.com). Example task link: https://example.planfix.com/task/12345 where 12345 is the planfix_object_id.</value>
                <value id="mwl_xlsx.planfix_mcp_endpoint">MCP endpoint URL</value>
                <value id="mwl_xlsx.planfix_mcp_endpoint.desc">Base URL for the MCP integration endpoint.</value>
                <value id="mwl_xlsx.planfix_mcp_auth_token">MCP auth token</value>
                <value id="mwl_xlsx.planfix_mcp_auth_token.desc">Token used to authorize requests to the MCP endpoint.</value>
                <value id="mwl_xlsx.planfix_webhook_basic_login">Webhook Basic Auth login</value>
                <value id="mwl_xlsx.planfix_webhook_basic_login.desc">Login for protecting the incoming webhook with HTTP Basic authentication.</value>
                <value id="mwl_xlsx.planfix_webhook_basic_password">Webhook Basic Auth password</value>
                <value id="mwl_xlsx.planfix_webhook_basic_password.desc">Password for protecting the incoming webhook with HTTP Basic authentication.</value>
                <value id="mwl_xlsx.planfix_direction_default">Default task direction</value>
                <value id="mwl_xlsx.planfix_direction_default.desc">Direction that will be assigned to new tasks when MCP does not provide one.</value>
                <value id="mwl_xlsx.planfix_auto_task_statuses">Statuses for automatic task creation</value>
                <value id="mwl_xlsx.planfix_auto_task_statuses.desc">List of CS-Cart statuses that trigger automatic Planfix task creation (comma or newline separated).</value>
                <value id="mwl_xlsx.planfix_sync_comments">Sync comments with Planfix</value>
                <value id="mwl_xlsx.planfix_sync_comments.desc">Enable synchronization of CS-Cart comments with Planfix.</value>
                <value id="mwl_xlsx.planfix_sync_payments">Sync payments with Planfix</value>
                <value id="mwl_xlsx.planfix_sync_payments.desc">Enable synchronization of payment information with Planfix.</value>
                <value id="mwl_xlsx.planfix_webhook_allowlist_ips">Webhook IP allowlist</value>
                <value id="mwl_xlsx.planfix_webhook_allowlist_ips.desc">Optional list of IP addresses allowed to call the webhook (comma or newline separated). Leave empty to allow all.</value>
            </values>
        </item>
        <item>
            <name>ru</name>
            <values>
                <value id="mwl_xlsx.add_all_to_wishlist">Добавить все в подборку</value>
                <value id="mwl_xlsx.add_to_wishlist">Добавить в подборку</value>
                <value id="mwl_xlsx.added_plain">Добавлено в подборку</value>
                <value id="mwl_xlsx.added"><![CDATA[Добавлено в <a href="[list_url]">[list_name]</a>]]></value>
                <value id="mwl_xlsx.allowed_usergroups">Группы пользователей, которым разрешён доступ к mwl lists</value>
                <value id="mwl_xlsx.authorized_usergroups">Группы пользователей авторизованных</value>
                <value id="mwl_xlsx.confirm_remove">Удалить эту подборку?</value>
                <value id="mwl_xlsx.currencies_path">Путь к JSON валют</value>
                <value id="mwl_xlsx.description">Создание и управление несколькими подборками.</value>
                <value id="mwl_xlsx.enter_list_name">Введите название подборки</value>
                <value id="mwl_xlsx.export_google">Экспорт в Google Таблицы</value>
                <value id="mwl_xlsx.google_credentials">Учетные данные Google (JSON)</value>
                <value id="mwl_xlsx.google_drive_folder_id">ID папки Google Диска (необязательно, поддерживаются Общие диски)</value>
                <value id="mwl_xlsx.hide_price_for_guests">Скрывать цену для неавторизованных</value>
                <value id="mwl_xlsx.list_limit_reached">Нельзя добавить более [limit] товаров в подборку</value>
                <value id="mwl_xlsx.login_to_view_price">Войдите, чтобы увидеть цену</value>
                <value id="mwl_xlsx.max_list_items">Максимальное число товаров в подборке</value>
                <value id="mwl_xlsx.setting.compact_price_slider_labels">Компактные подписи ценового слайдера</value>
                <value id="mwl_xlsx.setting.compact_price_slider_labels.desc">Показывать min/max у слайдера в коротком формате, не влияя на значения фильтра.</value>
                <value id="mwl_xlsx.shortnum_thousand"> тыс.</value>
                <value id="mwl_xlsx.shortnum_million"> млн.</value>
                <value id="mwl_xlsx.shortnum_billion"> млрд.</value>
                <value id="mwl_xlsx.shortnum_trillion"> трлн.</value>
                <value id="mwl_xlsx.my_lists">Мои подборки</value>
                <value id="mwl_xlsx.name">Несколько подборок</value>
                <value id="mwl_xlsx.new_list">Новая подборка…</value>
                <value id="mwl_xlsx.remove_from_list">Удалить из подборки</value>
                <value id="mwl_xlsx.remove">Удалить</value>
                <value id="mwl_xlsx.removed">Удалено</value>
                <value id="mwl_xlsx.rename">Переименовать</value>
                <value id="mwl_xlsx.show_extra_button">Выводить кнопку extra в списке</value>
                <value id="mwl_xlsx.select_list">Выберите подборку</value>
                <value id="mwl_xlsx.wishlists">Подборки</value>
                <value id="mwl_xlsx.planfix_task">Задача Planfix</value>
                <value id="mwl_xlsx.planfix_origin">Адрес Planfix</value>
                <value id="mwl_xlsx.planfix_origin.desc"><![CDATA[Базовый адрес Planfix (пример: https://example.planfix.com). Пример ссылки на задачу: https://example.planfix.com/task/12345, где 12345 — planfix_object_id.]]></value>
                <value id="mwl_xlsx.planfix_mcp_endpoint">URL MCP-эндпоинта</value>
                <value id="mwl_xlsx.planfix_mcp_endpoint.desc">Базовый адрес эндпоинта MCP для интеграции.</value>
                <value id="mwl_xlsx.planfix_mcp_auth_token">Токен авторизации MCP</value>
                <value id="mwl_xlsx.planfix_mcp_auth_token.desc">Токен, используемый для авторизации запросов к MCP.</value>
                <value id="mwl_xlsx.planfix_webhook_basic_login">Логин Basic Auth вебхука</value>
                <value id="mwl_xlsx.planfix_webhook_basic_login.desc">Логин для защиты входящего вебхука базовой HTTP-аутентификацией.</value>
                <value id="mwl_xlsx.planfix_webhook_basic_password">Пароль Basic Auth вебхука</value>
                <value id="mwl_xlsx.planfix_webhook_basic_password.desc">Пароль для защиты входящего вебхука базовой HTTP-аутентификацией.</value>
                <value id="mwl_xlsx.planfix_direction_default">Направление по умолчанию</value>
                <value id="mwl_xlsx.planfix_direction_default.desc">Направление, которое будет присваиваться новым задачам, если MCP не передаёт значение.</value>
                <value id="mwl_xlsx.planfix_auto_task_statuses">Статусы для автосоздания задач</value>
                <value id="mwl_xlsx.planfix_auto_task_statuses.desc">Список статусов CS-Cart, при которых автоматически создаются задачи в Planfix (разделяйте запятыми или переводами строки).</value>
                <value id="mwl_xlsx.planfix_sync_comments">Синхронизировать комментарии</value>
                <value id="mwl_xlsx.planfix_sync_comments.desc">Включите синхронизацию комментариев из CS-Cart с Planfix.</value>
                <value id="mwl_xlsx.planfix_sync_payments">Синхронизировать платежи</value>
                <value id="mwl_xlsx.planfix_sync_payments.desc">Включите синхронизацию информации об оплате с Planfix.</value>
                <value id="mwl_xlsx.planfix_webhook_allowlist_ips">Allowlist IP вебхука</value>
                <value id="mwl_xlsx.planfix_webhook_allowlist_ips.desc">Необязательный список IP-адресов, которым разрешён доступ к вебхуку (разделяйте запятыми или переводами строки). Оставьте пустым, чтобы разрешить всем.</value>
                <value id="mwl_xlsx.xlsx_templates">XLSX Шаблоны</value>
                <value id="mwl_xlsx.invites">Приглашения</value>
                <value id="mwl_xlsx.settings">Настройки</value>
                <value id="mwl_xlsx.notify_via">Способ уведомления</value>
                <value id="mwl_xlsx.notify_via_telegram">Telegram</value>
                <value id="mwl_xlsx.notify_via_email">Email</value>
                <value id="mwl_xlsx.telegram_bot_token">Токен Telegram бота</value>
                <value id="mwl_xlsx.telegram_chat_id">ID чата Telegram</value>
                <value id="mwl_xlsx.notify_email">Email для уведомлений</value>
            </values>
        </item>
    </languages>

    <settings>
        <sections>
            <section id="general">
                <items>
                    <item id="hide_price_for_guests" type="checkbox">
                        <name>mwl_xlsx.hide_price_for_guests</name>
                        <value>N</value>
                    </item>
                    <item id="authorized_usergroups" type="selectbox" multiple="true">
                        <name>mwl_xlsx.authorized_usergroups</name>
                        <variants_function>fn_get_usergroups</variants_function>
                    </item>
                    <item id="show_extra_button" type="checkbox">
                        <name>mwl_xlsx.show_extra_button</name>
                        <value>Y</value>
                    </item>
                    <item id="allowed_usergroups" type="selectbox" multiple="true">
                        <name>mwl_xlsx.allowed_usergroups</name>
                        <variants_function>fn_get_usergroups</variants_function>
                    </item>
                    <item id="max_list_items" type="input">
                        <name>mwl_xlsx.max_list_items</name>
                        <value>50</value>
                    </item>
                    <item id="currencies_path" type="input">
                        <name>mwl_xlsx.currencies_path</name>
                        <value></value>
                    </item>
                    <item id="planfix_origin" type="input">
                        <name>mwl_xlsx.planfix_origin</name>
                        <tooltip>mwl_xlsx.planfix_origin.desc</tooltip>
                        <value></value>
                    </item>
                    <item id="google_credentials" type="textarea">
                        <name>mwl_xlsx.google_credentials</name>
                    </item>
                    <item id="google_drive_folder_id" type="input">
                        <name>mwl_xlsx.google_drive_folder_id</name>
                    </item>
                    <item id="compact_price_slider_labels" type="checkbox">
                        <name>mwl_xlsx.setting.compact_price_slider_labels</name>
                        <value>Y</value>
                    </item>
                </items>
            </section>
            <section id="notifications">
                <items>
                    <item id="notify_via" type="selectbox">
                        <name>mwl_xlsx.notify_via</name>
                        <variants>
                            <item id="telegram">
                                <name>mwl_xlsx.notify_via_telegram</name>
                            </item>
                            <item id="email">
                                <name>mwl_xlsx.notify_via_email</name>
                            </item>
                        </variants>
                        <value>telegram</value>
                    </item>
                    <item id="telegram_bot_token" type="input">
                        <name>mwl_xlsx.telegram_bot_token</name>
                    </item>
                    <item id="telegram_chat_id" type="input">
                        <name>mwl_xlsx.telegram_chat_id</name>
                    </item>
                    <item id="notify_email" type="input">
                        <name>mwl_xlsx.notify_email</name>
                    </item>
                </items>
            </section>
            <section id="planfix_integration">
                <items>
                    <item id="planfix_mcp_endpoint" type="input">
                        <name>mwl_xlsx.planfix_mcp_endpoint</name>
                        <tooltip>mwl_xlsx.planfix_mcp_endpoint.desc</tooltip>
                    </item>
                    <item id="planfix_mcp_auth_token" type="input">
                        <name>mwl_xlsx.planfix_mcp_auth_token</name>
                        <tooltip>mwl_xlsx.planfix_mcp_auth_token.desc</tooltip>
                    </item>
                    <item id="planfix_webhook_basic_login" type="input">
                        <name>mwl_xlsx.planfix_webhook_basic_login</name>
                        <tooltip>mwl_xlsx.planfix_webhook_basic_login.desc</tooltip>
                    </item>
                    <item id="planfix_webhook_basic_password" type="input">
                        <name>mwl_xlsx.planfix_webhook_basic_password</name>
                        <tooltip>mwl_xlsx.planfix_webhook_basic_password.desc</tooltip>
                    </item>
                    <item id="planfix_direction_default" type="input">
                        <name>mwl_xlsx.planfix_direction_default</name>
                        <tooltip>mwl_xlsx.planfix_direction_default.desc</tooltip>
                    </item>
                    <item id="planfix_auto_task_statuses" type="textarea">
                        <name>mwl_xlsx.planfix_auto_task_statuses</name>
                        <tooltip>mwl_xlsx.planfix_auto_task_statuses.desc</tooltip>
                    </item>
                    <item id="planfix_sync_comments" type="checkbox">
                        <name>mwl_xlsx.planfix_sync_comments</name>
                        <tooltip>mwl_xlsx.planfix_sync_comments.desc</tooltip>
                        <value>N</value>
                    </item>
                    <item id="planfix_sync_payments" type="checkbox">
                        <name>mwl_xlsx.planfix_sync_payments</name>
                        <tooltip>mwl_xlsx.planfix_sync_payments.desc</tooltip>
                        <value>N</value>
                    </item>
                    <item id="planfix_webhook_allowlist_ips" type="textarea">
                        <name>mwl_xlsx.planfix_webhook_allowlist_ips</name>
                        <tooltip>mwl_xlsx.planfix_webhook_allowlist_ips.desc</tooltip>
                    </item>
                </items>
            </section>
        </sections>
    </settings>
</addon>
